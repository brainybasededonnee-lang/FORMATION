<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Plateforme Vidéo — Avancé (Mobile & Social)</title>

<meta name="theme-color" content="#0b76ef"/>

<style>
  :root{
    --bg:#f4f7fb;
    --card:#ffffff;
    --primary:#0b76ef;
    --accent:#10b981;
    --muted:#6b7280;
    --danger:#ef4444;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:Inter, "Segoe UI", Arial, sans-serif;
    background:var(--bg); color:#111;
    -webkit-font-smoothing:antialiased;
  }

  /* header */
  header{
    background:linear-gradient(90deg,var(--primary),#0046a8);
    color:white; padding:12px 14px; display:flex; gap:12px; align-items:center;
    justify-content:space-between;
  }
  header h1{font-size:18px;margin:0}
  .search{flex:1;max-width:520px;margin-left:12px;}
  .search input{width:100%;padding:8px 12px;border-radius:999px;border:none;outline:none;}

  /* main layout */
  .wrap{display:flex;gap:16px;padding:16px;max-width:1200px;margin:auto;}
  nav{width:220px;min-width:160px;}
  main{flex:1;}

  /* sidebar */
  .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(11,55,120,0.06);margin-bottom:16px}
  .category{padding:10px;border-radius:8px;cursor:pointer;color:var(--primary);margin-bottom:6px}
  .category.active{background:#e8f2ff}

  /* grid */
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
  .video-card{background:var(--card);border-radius:12px;overflow:hidden;box-shadow:0 6px 18px rgba(11,55,120,0.06);cursor:pointer;display:flex;flex-direction:column}
  .thumb{height:140px;background-size:cover;background-position:center}
  .meta{padding:10px;display:flex;flex-direction:column;gap:6px}
  .meta h3{margin:0;font-size:15px}
  .meta .sub{color:var(--muted);font-size:13px}

  /* player page */
  .player-page{display:none;padding:12px}
  .player-top{display:flex;gap:12px;flex-direction:column}
  .player-frame{width:100%;height:420px;border-radius:12px;overflow:hidden;background:#000}
  .player-controls{display:flex;gap:8px;align-items:center;margin-top:8px}
  .btn{padding:8px 12px;border-radius:8px;border:none;background:var(--primary);color:#fff;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid #e6eefc;color:var(--primary)}

  /* comments & likes */
  .actions{display:flex;gap:8px;align-items:center}
  .like{background:var(--danger);color:#fff;padding:8px 10px;border-radius:8px;border:none;cursor:pointer}
  .comment-box{display:flex;gap:8px;margin-top:10px}
  .comment-box input{flex:1;padding:10px;border-radius:8px;border:1px solid #e6e9ef}
  .comment-box button{padding:10px 12px;border-radius:8px;border:none;background:var(--primary);color:#fff;cursor:pointer}

  .comments-list{margin-top:10px;display:flex;flex-direction:column;gap:8px}
  .comment{background:#fbfdff;padding:8px;border-radius:8px;border:1px solid #eef4ff}
  .comment .meta{display:flex;justify-content:space-between;color:var(--muted);font-size:12px}

  /* floating player */
  #floatPlayer{position:fixed;right:12px;bottom:12px;width:320px;background:var(--card);border-radius:12px;padding:10px;box-shadow:0 8px 28px rgba(0,0,0,0.18);display:none;z-index:9999}
  #floatFrame{width:100%;height:180px;border-radius:8px;border:none}

  /* small screens */
  @media (max-width:900px){
    .wrap{flex-direction:column;padding:12px}
    nav{width:100%}
    .grid{grid-template-columns:repeat(auto-fill,minmax(160px,1fr))}
    .player-frame{height:240px}
  }

  /* tiny */
  @media (max-width:480px){
    header h1{font-size:16px}
    #floatPlayer{left:12px;right:12px;width:auto}
  }
</style>
</head>
<body>

<header>
  <h1>Brainy • Plateforme</h1>
  <div class="search">
    <input id="globalSearch" placeholder="Rechercher une vidéo..." oninput="applySearch()" />
  </div>

  <div style="display:flex;gap:8px;align-items:center">
    <button class="btn ghost" onclick="promptUsername()">Profil</button>
    <button class="btn" onclick="showHome()">Accueil</button>
  </div>
</header>

<div class="wrap">
  <!-- sidebar categories -->
  <nav>
    <div class="card">
      <h3>Catégories</h3>
      <div id="catList"></div>
    </div>

    <div class="card">
      <h3>Tri</h3>
      <select id="sortSelect" onchange="applyFilters()">
        <option value="new">Les plus récents</option>
        <option value="popular">Les plus likés</option>
      </select>
    </div>

    <div class="card">
      <h3>Utilisateur</h3>
      <div id="userBox">Pas de pseudo — <button class="btn ghost" onclick="promptUsername()">Choisir</button></div>
    </div>
  </nav>

  <!-- main content -->
  <main>
    <!-- home grid -->
    <section id="homeSection">
      <div class="grid" id="grid"></div>
    </section>

    <!-- player page -->
    <section id="playerSection" class="player-page">
      <div class="player-top">
        <div class="player-frame" id="playerFrame"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
          <div>
            <h2 id="playerTitle"></h2>
            <div id="playerCategory" style="color:var(--muted)"></div>
          </div>
          <div class="player-actions">
            <div class="actions">
              <button id="likeBtn" class="like" onclick="toggleLike()">❤️ 0</button>
              <button class="btn" onclick="openInNew()">Ouvrir</button>
            </div>
          </div>
        </div>

        <div style="margin-top:8px">
          <div class="comment-box">
            <input id="commentInput" placeholder="Ajouter un commentaire..." />
            <button onclick="postComment()">Publier</button>
          </div>
          <div class="comments-list" id="commentsList"></div>
        </div>
      </div>

      <h3 style="margin-top:12px">Suggestions</h3>
      <div id="suggestions" class="grid" style="margin-top:8px"></div>
    </section>
  </main>
</div>

<!-- floating player -->
<div id="floatPlayer">
  <div style="display:flex;justify-content:flex-end"><button class="btn ghost" onclick="closeFloat()">Fermer</button></div>
  <iframe id="floatFrame"></iframe>
</div>

<script>
/* ============================
   CONFIG — AJOUTE TES VIDEOS ICI
   - lien: youtube embed OR drive link OR direct mp4
   - thumb: url image miniature
===============================*/
const VIDEOS = [
  { id: 1, title: "Intro Informatique", category: "Informatique", link: "https://drive.google.com/file/d/153eKhhHoWjzHB8_JCWehjeKf4bvr1iq5/view?usp=sharing", thumb: "https://i.ytimg.com/vi/dQw4w9WgXcQ/hqdefault.jpg", created: 1690000000000 },
  { id: 2, title: "Motivation quotidienne", category: "Motivation", link: "https://drive.google.com/uc?export=preview&id=1FVSRziGlTHGAqelePb553Ez6Z-KennAE", thumb: "https://i.ytimg.com/vi/DLX62G4lc44/hqdefault.jpg", created: 1692000000000 },
  { id: 3, title: "Lancer son business", category: "Business", link: "https://example.com/video.mp4", thumb: "https://i.ytimg.com/vi/lkIFF4maKMU/hqdefault.jpg", created: 1693000000000 }
];

/* stockages */
const STORAGE_PREFIX = "brainy_v1_";
function likesKey(){ return STORAGE_PREFIX + "likes"; }
function commentsKey(){ return STORAGE_PREFIX + "comments"; }
function userKey(){ return STORAGE_PREFIX + "user"; }

/* ============================
   UTILITAIRES
===============================*/
function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
function load(key, def){ return JSON.parse(localStorage.getItem(key) || JSON.stringify(def)); }

/* init storage if absent */
if(!localStorage.getItem(likesKey())) save(likesKey(), {}); // { videoId: [usernames...] }
if(!localStorage.getItem(commentsKey())) save(commentsKey(), {}); // { videoId: [{id, user, text, ts}] }

/* ============================
   USER (pseudo)
===============================*/
function promptUsername(){
  let current = localStorage.getItem(userKey());
  let name = prompt("Entrez votre pseudo (sera stocké localement) :", current || "");
  if(name){
    localStorage.setItem(userKey(), name);
    document.getElementById("userBox").innerHTML = `Connecté comme <strong>${escapeHtml(name)}</strong>`;
  }
}
function getUser(){ return localStorage.getItem(userKey()) || null; }
function ensureUserUI(){ let u = getUser(); if(u) document.getElementById("userBox").innerHTML = `Connecté comme <strong>${escapeHtml(u)}</strong>`; }

/* ============================
   RENDER GRID
===============================*/
function buildCategories(){
  const cats = ["Toutes", ...Array.from(new Set(VIDEOS.map(v=>v.category)))];
  const container = document.getElementById("catList");
  container.innerHTML = "";
  cats.forEach(c=>{
    const el = document.createElement("div");
    el.className = "category" + (c==="Toutes" ? " active" : "");
    el.textContent = c;
    el.onclick = ()=>{ document.querySelectorAll(".category").forEach(n=>n.classList.remove("active")); el.classList.add("active"); applyFilters(); };
    container.appendChild(el);
  });
}

function renderGrid(list){
  const g = document.getElementById("grid");
  g.innerHTML = "";
  list.forEach(v=>{
    const card = document.createElement("div"); card.className="video-card";
    card.onclick = ()=> openPlayer(v.id);
    const thumb = document.createElement("div"); thumb.className="thumb"; thumb.style.backgroundImage = `url('${v.thumb}')`;
    const meta = document.createElement("div"); meta.className="meta";
    meta.innerHTML = `<h3>${escapeHtml(v.title)}</h3><div class="sub">${escapeHtml(v.category)}</div>`;
    card.appendChild(thumb); card.appendChild(meta);
    g.appendChild(card);
  });
}

/* ============================
   FILTERS & SEARCH & SORT
===============================*/
function applyFilters(){
  const activeCat = Array.from(document.querySelectorAll(".category")).find(c=>c.classList.contains("active"))?.textContent || "Toutes";
  const q = (document.getElementById("globalSearch").value||"").toLowerCase();
  const sort = document.getElementById("sortSelect").value;
  let list = VIDEOS.filter(v=>{
    const catMatch = (activeCat==="Toutes") || v.category===activeCat;
    const searchMatch = v.title.toLowerCase().includes(q) || v.category.toLowerCase().includes(q);
    return catMatch && searchMatch;
  });
  if(sort==="popular"){
    const lk = load(likesKey(), {});
    list.sort((a,b)=> (lk[b.id]?.length||0) - (lk[a.id]?.length||0));
  } else {
    list.sort((a,b)=> b.created - a.created);
  }
  renderGrid(list);
}
function applySearch(){ applyFilters(); }
function showHome(){ document.getElementById("playerSection").style.display="none"; document.getElementById("homeSection").style.display="block"; document.getElementById("floatPlayer").style.display="none"; }

/* ============================
   PLAYER (page) + FLOAT
===============================*/
let currentVideo = null;
function openPlayer(id){
  const v = VIDEOS.find(x=>x.id===id); if(!v) return;
  currentVideo = v;
  document.getElementById("homeSection").style.display="none";
  document.getElementById("playerSection").style.display="block";
  document.getElementById("playerTitle").textContent = v.title;
  document.getElementById("playerCategory").textContent = v.category;
  // render player element (handle youtube embed, drive, mp4)
  const frame = document.getElementById("playerFrame");
  frame.innerHTML = renderPlayerHtml(v.link);
  // load likes/comments UI
  updateLikeButton();
  renderComments();
  // suggestions
  renderSuggestions(id);
  // open float
  openFloat(v.link);
}
function renderPlayerHtml(link){
  if(link.includes("youtube.com") || link.includes("youtube-nocookie.com") || link.includes("youtu.be") || link.includes("embed")){
    // if not embed, try to transform watch?v= -> embed
    let embed = link;
    if(link.includes("watch?v=")) embed = link.replace("watch?v=", "embed/");
    if(link.includes("youtu.be/")) embed = link.replace("youtu.be/","www.youtube.com/embed/");
    return `<iframe src="${embed}" style="width:100%;height:100%;border:none;border-radius:8px"></iframe>`;
  }
  if(link.includes("drive.google.com") || link.includes("drive")){
    // convert to uc?export=preview
    const id = extractDriveId(link);
    const url = id ? `https://drive.google.com/uc?export=preview&id=${id}` : link;
    return `<iframe src="${url}" style="width:100%;height:100%;border:none;border-radius:8px"></iframe>`;
  }
  // assume mp4
  return `<video controls style="width:100%;height:100%;border-radius:8px"><source src="${link}"></video>`;
}

function openFloat(link){
  const fp = document.getElementById("floatPlayer");
  document.getElementById("floatFrame").src = transformLinkForFloat(link);
  fp.style.display = "block";
}
function closeFloat(){ document.getElementById("floatPlayer").style.display="none"; document.getElementById("floatFrame").src=""; }
function openInNew(){
  if(!currentVideo) return;
  window.open(currentVideo.link, "_blank");
}
function transformLinkForFloat(link){
  if(link.includes("watch?v=")) return link.replace("watch?v=","embed/");
  if(link.includes("youtu.be/")) return link.replace("youtu.be/","www.youtube.com/embed/");
  if(link.includes("drive.google.com")){ const id = extractDriveId(link); return id ? `https://drive.google.com/uc?export=preview&id=${id}` : link; }
  return link;
}

/* ============================
   LIKES (par utilisateur)
===============================*/
function updateLikeButton(){
  const btn = document.getElementById("likeBtn");
  if(!currentVideo) return;
  const user = getUser();
  const likes = load(likesKey(), {});
  const list = likes[currentVideo.id] || [];
  const count = list.length || 0;
  btn.innerText = `❤️ ${count}`;
  // highlight if user liked
  if(user && list.includes(user)) btn.style.opacity = "0.7"; else btn.style.opacity = "1";
}
function toggleLike(){
  const user = getUser();
  if(!user){ alert("Créez d'abord un pseudo pour liker (Profil)."); return; }
  if(!currentVideo) return;
  const likes = load(likesKey(), {});
  const arr = likes[currentVideo.id] || [];
  const idx = arr.indexOf(user);
  if(idx === -1) arr.push(user); else arr.splice(idx,1);
  likes[currentVideo.id] = arr;
  save(likesKey(), likes);
  updateLikeButton();
  applyFilters(); // refresh ordering if sorting by popular
}

/* ============================
   COMMENTS (full)
===============================*/
function renderComments(){
  if(!currentVideo) return;
  const listEl = document.getElementById("commentsList");
  listEl.innerHTML = "";
  const all = load(commentsKey(), {});
  const items = all[currentVideo.id] || [];
  items.slice().reverse().forEach(c=>{
    const div = document.createElement("div"); div.className = "comment";
    const meta = document.createElement("div"); meta.className = "meta";
    const left = document.createElement("div"); left.textContent = `${escapeHtml(c.user)} • ${new Date(c.ts).toLocaleString()}`;
    const right = document.createElement("div");
    if(getUser() === c.user){
      const del = document.createElement("button"); del.textContent="Supprimer"; del.style.background="transparent"; del.style.color="var(--danger)"; del.style.border="none"; del.style.cursor="pointer";
      del.onclick = (e)=>{ e.stopPropagation(); deleteComment(c.id); };
      right.appendChild(del);
    }
    meta.appendChild(left); meta.appendChild(right);
    const text = document.createElement("div"); text.style.marginTop="6px"; text.textContent = c.text;
    div.appendChild(meta); div.appendChild(text);
    listEl.appendChild(div);
  });
}
function postComment(){
  const user = getUser();
  if(!user){ alert("Créez un pseudo pour commenter."); return; }
  const txt = document.getElementById("commentInput").value.trim();
  if(!txt) return;
  const all = load(commentsKey(), {});
  const arr = all[currentVideo.id] || [];
  const commentObj = { id: Date.now() + Math.random(), user, text: txt, ts: Date.now() };
  arr.push(commentObj);
  all[currentVideo.id] = arr;
  save(commentsKey(), all);
  document.getElementById("commentInput").value = "";
  renderComments();
}
function deleteComment(cid){
  const all = load(commentsKey(), {});
  const arr = (all[currentVideo.id] || []).filter(c=> c.id !== cid);
  all[currentVideo.id] = arr;
  save(commentsKey(), all);
  renderComments();
}

/* ============================
   SUGGESTIONS
===============================*/
function renderSuggestions(currentId){
  const container = document.getElementById("suggestions");
  container.innerHTML = "";
  VIDEOS.filter(v=>v.id!==currentId).forEach(v=>{
    const card = document.createElement("div"); card.className="video-card"; card.style.cursor="pointer";
    card.onclick = ()=> openPlayer(v.id);
    const thumb = document.createElement("div"); thumb.className="thumb"; thumb.style.backgroundImage=`url('${v.thumb}')`;
    const meta = document.createElement("div"); meta.className="meta"; meta.innerHTML = `<h3>${escapeHtml(v.title)}</h3><div class="sub">${escapeHtml(v.category)}</div>`;
    card.appendChild(thumb); card.appendChild(meta);
    container.appendChild(card);
  });
}

/* ============================
   HELPERS
===============================*/
function extractDriveId(url){
  if(!url) return null;
  const m = url.match(/\/d\/([A-Za-z0-9_-]+)/);
  if(m) return m[1];
  const m2 = url.match(/[?&]id=([A-Za-z0-9_-]+)/);
  if(m2) return m2[1];
  return null;
}
function escapeHtml(s){ if(!s) return ""; return String(s).replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ============================
   INIT
===============================*/
function init(){
  ensureUserUI();
  buildCategories();
  applyFilters();
}
init();

/* ============================
   PWA: manifest + service worker (tentative)
   - Requires HTTPS to fully work.
===============================*/
(function tryRegisterSW(){
  if('serviceWorker' in navigator){
    // create simple service worker script as blob
    const swCode = `
      const CACHE = 'brainy-cache-v1';
      self.addEventListener('install', e=>{ e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['/','/index.html'])).catch(()=>{})); self.skipWaiting(); });
      self.addEventListener('activate', e=>{ e.waitUntil(self.clients.claim()); });
      self.addEventListener('fetch', e=>{ e.respondWith(fetch(e.request).catch(()=>caches.match(e.request))); });
    `;
    try{
      const blob = new Blob([swCode], {type:'text/javascript'});
      const swUrl = URL.createObjectURL(blob);
      navigator.serviceWorker.register(swUrl).then(()=>{ console.log('Service worker enregistré (blob)'); }).catch(err=>{ console.warn('SW error', err); });
    }catch(err){
      console.warn('SW non supporté:', err);
    }
  }
})();

/* create a simple manifest dynamically (works when hosted) */
(function createManifest(){
  const manifest = {
    "name":"Brainy Vidéo",
    "short_name":"Brainy",
    "start_url":".",
    "display":"standalone",
    "background_color":"#0b76ef",
    "theme_color":"#0b76ef",
    "icons":[{ "src":"", "sizes":"192x192", "type":"image/png" }]
  };
  const blob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const link = document.createElement('link'); link.rel='manifest'; link.href = url;
  document.head.appendChild(link);
})();

</script>
</body>
</html>

